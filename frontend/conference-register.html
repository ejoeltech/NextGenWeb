<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register for Conference - NextGen Community</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo-container">
                <a href="/">
                    <img src="/assets/logo.png" alt="NextGen Logo" class="logo" id="logo-img">
                </a>
            </div>
            <ul class="nav-menu">
                <li><a href="/#home">Home</a></li>
                <li><a href="/#about">About</a></li>
                <li><a href="/#programs">Programs</a></li>
                <li><a href="/#awareness">Awareness</a></li>
                <li><a href="/conferences">Conferences</a></li>
                <li><a href="/#register">Join Us</a></li>
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Registration Section -->
    <section id="register" class="register" style="padding-top: 120px;">
        <div class="container">
            <div id="registration-container">
                <div class="loading" style="text-align: center; padding: 4rem; color: var(--text-secondary);">
                    Loading registration form...
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <img src="/assets/logo.png" alt="NextGen Logo" id="footer-logo-img">
                    </div>
                    <p>Empowering Nigerian youth through political awareness and civic engagement.</p>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p id="contact-info">Email: info@nextgencommunity.ng<br>Phone: +234 XXX XXX XXXX</p>
                </div>
                <div class="footer-section">
                    <h3>Follow Us</h3>
                    <div class="social-icons">
                        <a href="#" class="social-icon" aria-label="Facebook">üìò</a>
                        <a href="#" class="social-icon" aria-label="Twitter">üê¶</a>
                        <a href="#" class="social-icon" aria-label="Instagram">üì∑</a>
                        <a href="#" class="social-icon" aria-label="LinkedIn">üíº</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>NGO Compliance</h3>
                    <p id="ngo-info">Registered as a non-governmental organization committed to youth empowerment and civic education.</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 NextGen Community. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="/nigerian-data.js"></script>
    <script src="/typeahead.js"></script>
    <script>
        const API_BASE = window.location.origin;
        
        // Extract conference ID from URL (format: /conference/:id/register)
        const pathParts = window.location.pathname.split('/').filter(p => p);
        let conferenceId = null;
        
        // Find conference ID in URL
        const conferenceIndex = pathParts.indexOf('conference');
        if (conferenceIndex !== -1 && pathParts[conferenceIndex + 1]) {
            conferenceId = pathParts[conferenceIndex + 1];
        } else {
            // Fallback: try to get from path
            conferenceId = pathParts[pathParts.length - 2] || pathParts[pathParts.length - 1];
        }

        console.log('Conference ID:', conferenceId);
        console.log('Path parts:', pathParts);

        // Mobile Menu Toggle
        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');

        if (hamburger) {
            hamburger.addEventListener('click', () => {
                navMenu.classList.toggle('active');
            });
        }

        // Populate state dropdowns
        function populateStateDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (select && typeof nigerianStates !== 'undefined') {
                nigerianStates.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    select.appendChild(option);
                });
            }
        }

        // Populate institution dropdown
        function populateInstitutionDropdown() {
            const select = document.getElementById('institution');
            if (select && typeof allInstitutions !== 'undefined') {
                allInstitutions.forEach(institution => {
                    const option = document.createElement('option');
                    option.value = institution;
                    option.textContent = institution;
                    select.appendChild(option);
                });
            }
        }

        let conferenceData = null;

        // Load conference and show form
        async function loadRegistrationForm() {
            if (!conferenceId) {
                document.getElementById('registration-container').innerHTML = `
                    <div class="glass-card" style="text-align: center; padding: 4rem;">
                        <h2 style="color: var(--primary-red); margin-bottom: 1rem;">Invalid Conference</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 2rem;">Unable to determine conference ID from URL.</p>
                        <a href="/conferences" class="submit-btn" style="display: inline-block; text-decoration: none;">Back to Conferences</a>
                    </div>
                `;
                return;
            }

            try {
                console.log('Fetching conference:', `${API_BASE}/api/conferences/${conferenceId}`);
                const response = await fetch(`${API_BASE}/api/conferences/${conferenceId}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Conference not found');
                    }
                    throw new Error(`Server error: ${response.status}`);
                }
                
                conferenceData = await response.json();
                console.log('Conference data loaded:', conferenceData);

                const hasDate = conferenceData.date && conferenceData.date.trim() !== '';
                let date, isPast, dateStr;
                
                if (hasDate) {
                    date = new Date(conferenceData.date);
                    const now = new Date();
                    isPast = date < now;
                    dateStr = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                } else {
                    isPast = false;
                    dateStr = 'Coming Soon';
                }

                if (isPast) {
                    document.getElementById('registration-container').innerHTML = `
                        <div class="glass-card" style="text-align: center; padding: 4rem;">
                            <h2 style="color: var(--primary-red); margin-bottom: 1rem;">Event Has Ended</h2>
                            <p style="color: var(--text-secondary); margin-bottom: 2rem;">This conference has already taken place.</p>
                            <a href="/conferences" class="submit-btn" style="display: inline-block; text-decoration: none;">View Other Conferences</a>
                        </div>
                    `;
                    return;
                }

                const container = document.getElementById('registration-container');
                const venueInfo = conferenceData.venue ? `${conferenceData.venue}${conferenceData.address ? ', ' + conferenceData.address : ''}` : (conferenceData.address || '');
                
                container.innerHTML = `
                    <h2 class="section-title">Pre-Register for: ${conferenceData.title}</h2>
                    ${venueInfo || dateStr ? `
                        <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem; font-size: 1.1rem;">
                            ${dateStr ? `üìÖ ${dateStr}` : ''}${dateStr && venueInfo ? ' | ' : ''}${venueInfo ? `üìç ${venueInfo}` : ''}
                        </p>
                    ` : ''}
                    <div class="registration-form-container glass-card">
                        <form id="registration-form" class="registration-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fullname">Full Name *</label>
                                    <input type="text" id="fullname" name="fullname" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email *</label>
                                    <input type="email" id="email" name="email" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="phone">Phone *</label>
                                    <input type="tel" id="phone" name="phone" required>
                                </div>
                                <div class="form-group">
                                    <label for="date_of_birth">Date of Birth *</label>
                                    <input type="date" id="date_of_birth" name="date_of_birth" required>
                                </div>
                            </div>
                            <div class="form-row">
                                    <div class="form-group">
                                        <label for="state">State *</label>
                                        <div class="typeahead-container">
                                            <input type="text" id="state" name="state" class="typeahead-input" autocomplete="off" required placeholder="Type to search state...">
                                            <input type="hidden" id="state-value" name="state">
                                            <ul class="typeahead-dropdown" id="state-dropdown"></ul>
                                        </div>
                                    </div>
                                <div class="form-group">
                                    <label for="organization">School / Organization</label>
                                    <input type="text" id="organization" name="organization">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="is_student">Are you a student? *</label>
                                <select id="is_student" name="is_student" required>
                                    <option value="">Select Option</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                                    <div class="form-group" id="institution-group" style="display: none;">
                                        <label for="institution">Which institution? * <span style="font-weight: normal; color: var(--text-secondary); font-size: 0.9em;">(Select Other if not listed)</span></label>
                                        <div class="typeahead-container">
                                            <input type="text" id="institution" name="institution" class="typeahead-input" autocomplete="off" placeholder="Type to search institution...">
                                            <input type="hidden" id="institution-value" name="institution">
                                            <ul class="typeahead-dropdown" id="institution-dropdown"></ul>
                                        </div>
                                    </div>
                            <div class="form-group">
                                <label for="is_registered_voter">Are you a registered voter? *</label>
                                <select id="is_registered_voter" name="is_registered_voter" required>
                                    <option value="">Select Option</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                                    <div class="form-group" id="voter-state-group" style="display: none;">
                                        <label for="voter_state">Which state are you registered to vote in? *</label>
                                        <div class="typeahead-container">
                                            <input type="text" id="voter_state" name="voter_state" class="typeahead-input" autocomplete="off" placeholder="Type to search state...">
                                            <input type="hidden" id="voter_state-value" name="voter_state">
                                            <ul class="typeahead-dropdown" id="voter_state-dropdown"></ul>
                                        </div>
                                    </div>
                            <div class="form-group">
                                <label for="attendance_type">Attendance Type *</label>
                                <select id="attendance_type" name="attendance_type" required>
                                    <option value="">Select Type</option>
                                    <option value="Physical">Physical</option>
                                    <option value="Virtual">Virtual</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="referral_code">Referral Code (Optional)</label>
                                <input type="text" id="referral_code" name="referral_code" placeholder="Enter referral code if you have one" style="text-transform: uppercase;">
                                <small style="color: var(--text-secondary); font-size: 0.9rem; display: block; margin-top: 0.3rem;">If you have a referral code from an Institution Rep, enter it here</small>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="consent" name="consent" required style="width: auto;">
                                    <span>I consent to the collection and use of my information for this event *</span>
                                </label>
                            </div>
                            <button type="submit" class="submit-btn">Register Now</button>
                        </form>
                    </div>
                `;

                // Populate dropdowns after DOM is ready
                setTimeout(() => {
                    try {
                        if (typeof nigerianStates !== 'undefined' && nigerianStates) {
                            populateStateDropdown('state');
                            populateStateDropdown('voter_state');
                        }
                        if (typeof allInstitutions !== 'undefined' && allInstitutions) {
                            populateInstitutionDropdown();
                        }
                    } catch (error) {
                        console.error('Error populating dropdowns:', error);
                    }
                }, 200);

                // Handle student question
                const isStudent = document.getElementById('is_student');
                const institutionGroup = document.getElementById('institution-group');
                if (isStudent) {
                    isStudent.addEventListener('change', (e) => {
                        if (e.target.value === 'true') {
                            institutionGroup.style.display = 'block';
                            document.getElementById('institution').required = true;
                        } else {
                            institutionGroup.style.display = 'none';
                            document.getElementById('institution').required = false;
                            document.getElementById('institution').value = '';
                        }
                    });
                }

                // Handle voter question
                const isRegisteredVoter = document.getElementById('is_registered_voter');
                const voterStateGroup = document.getElementById('voter-state-group');
                if (isRegisteredVoter) {
                    isRegisteredVoter.addEventListener('change', (e) => {
                        if (e.target.value === 'true') {
                            voterStateGroup.style.display = 'block';
                            document.getElementById('voter_state').required = true;
                        } else {
                            voterStateGroup.style.display = 'none';
                            document.getElementById('voter_state').required = false;
                            document.getElementById('voter_state').value = '';
                        }
                    });
                }

                // Handle form submission
                document.getElementById('registration-form').addEventListener('submit', handleRegistration);
            } catch (error) {
                console.error('Error loading form:', error);
                const errorMessage = error.message || 'Unable to load registration form';
                document.getElementById('registration-container').innerHTML = `
                    <div class="glass-card" style="text-align: center; padding: 4rem;">
                        <h2 style="color: var(--primary-red); margin-bottom: 1rem;">Error</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">${errorMessage}</p>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 2rem;">Conference ID: ${conferenceId || 'Not found'}</p>
                        <a href="/conferences" class="submit-btn" style="display: inline-block; text-decoration: none;">Back to Conferences</a>
                    </div>
                `;
            }
        }

        async function handleRegistration(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                conference_id: conferenceId,
                fullname: formData.get('fullname'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                age: (() => {
                    const dob = new Date(formData.get('date_of_birth'));
                    const today = new Date();
                    let age = today.getFullYear() - dob.getFullYear();
                    const monthDiff = today.getMonth() - dob.getMonth();
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                        age--;
                    }
                    return age;
                })(),
                date_of_birth: formData.get('date_of_birth'),
                state: formData.get('state'),
                organization: formData.get('organization') || null,
                is_student: formData.get('is_student') === 'true',
                institution: formData.get('institution') || null,
                is_registered_voter: formData.get('is_registered_voter') === 'true',
                voter_state: formData.get('voter_state') || null,
                attendance_type: formData.get('attendance_type'),
                referral_code: formData.get('referral_code')?.toUpperCase().trim() || null,
                consent: formData.get('consent') === 'on'
            };

            try {
                const submitBtn = e.target.querySelector('.submit-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Registering...';

                const response = await fetch(`${API_BASE}/api/registrations/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    // Redirect to confirmation page
                    window.location.href = `/conference/${conferenceId}/confirmation?code=${result.registration.attendee_code}`;
                } else {
                    alert(result.error || 'Registration failed. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Register Now';
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('An error occurred. Please try again later.');
                e.target.querySelector('.submit-btn').disabled = false;
                e.target.querySelector('.submit-btn').textContent = 'Register Now';
            }
        }

        document.addEventListener('DOMContentLoaded', loadRegistrationForm);
    </script>
</body>
</html>

